name: Unit Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bats-core shellcheck shfmt

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck

          # Install shfmt manually on Linux
          curl -fsSL https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64 -o /tmp/shfmt
          sudo install /tmp/shfmt /usr/local/bin/shfmt

      - name: Run shellcheck
        run: |
          echo "Running shellcheck on install scripts..."
          find install -name "*.sh" -type f -exec shellcheck {} +

          echo "Running shellcheck on library scripts..."
          find scripts/lib -name "*.sh" -type f -exec shellcheck {} +

          echo "Running shellcheck on bootstrap script..."
          shellcheck scripts/bootstrap.sh scripts/coverage.sh

      - name: Run shfmt (check formatting)
        run: |
          echo "Checking shell script formatting..."
          shfmt -d install/ scripts/

      - name: Run unit tests
        run: |
          echo "Running bats unit tests..."
          bats tests/unit/

  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          curl -fsSL https://github.com/mvdan/sh/releases/download/v3.7.0/shfmt_v3.7.0_linux_amd64 -o /tmp/shfmt
          sudo install /tmp/shfmt /usr/local/bin/shfmt

      - name: Run shellcheck (strict)
        run: |
          shellcheck --severity=warning install/*.sh || true
          shellcheck --severity=warning scripts/**/*.sh || true

      - name: Check shell script formatting
        run: |
          if ! shfmt -d install/ scripts/; then
            echo "Shell scripts are not properly formatted"
            echo "Run: shfmt -w install/ scripts/"
            exit 1
          fi

      - name: Validate test structure
        run: |
          # Ensure all .bats files are in tests/ directory
          if find . -name "*.bats" -not -path "./tests/*" -not -path "./.git/*" | grep .; then
            echo "Found .bats files outside tests/ directory"
            exit 1
          fi

          echo "Test structure validation passed"
